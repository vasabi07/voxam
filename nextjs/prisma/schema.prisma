// Voxam Prisma Schema
// Simplified for MVP - no institution/teacher models (v2)

generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ========== CORE USER ==========

model User {
  id        String   @id // Supabase auth UID
  email     String   @unique
  name      String?
  avatarUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Usage (merged from UserCredits table)
  voiceMinutesUsed   Int @default(0)
  chatMessagesUsed   Int @default(0)
  pagesUsed          Int @default(0)
  voiceMinutesLimit  Int @default(15)   // Free tier: 1 short exam
  chatMessagesLimit  Int @default(100)  // Free tier default (100 for testing)
  pagesLimit         Int @default(3)    // Free tier: 1 small doc

  // Geo-based settings
  region             String @default("india")  // "india" or "global" - affects pricing & TTS

  // Relations
  documents    Document[]
  questionPapers QuestionPaper[]
  examSessions ExamSession[]
  learnSessions LearnSession[]
  transactions Transaction[]

  @@index([email])
}

// ========== DOCUMENTS ==========

model Document {
  id        String         @id @default(uuid())
  title     String
  fileKey   String         // R2/S3 storage key
  fileName  String?        // Original filename
  fileSize  Int?           // Size in bytes
  mimeType  String?        // application/pdf, etc.
  pageCount Int?
  status    DocumentStatus @default(PENDING)
  taskId    String?        // Celery task ID for processing
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  archivedAt DateTime?     // Soft delete - null means active

  // Relations
  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  examSessions ExamSession[]
  learnSessions LearnSession[]
  questionPapers QuestionPaper[]

  @@index([userId])
  @@index([status])
  @@index([archivedAt])
}

// ========== EXAM SESSIONS ==========

model ExamSession {
  id        String     @id @default(uuid())
  threadId  String     @unique // LangGraph thread ID
  mode      ExamMode   @default(EXAM)
  status    ExamStatus @default(SCHEDULED)

  // Timestamps
  startedAt   DateTime?
  endedAt     DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Voice minutes tracking (for billing actual connected time)
  totalConnectedSeconds Int       @default(0)  // Cumulative connected time
  lastConnectedAt       DateTime?              // When user last connected to LiveKit
  lastDisconnectedAt    DateTime?              // When user last disconnected

  // Relations
  userId     String
  user       User @relation(fields: [userId], references: [id], onDelete: Cascade)

  documentId String
  document   Document @relation(fields: [documentId], references: [id])

  questionPaperId String
  questionPaper   QuestionPaper @relation(fields: [questionPaperId], references: [id])

  report CorrectionReport?

  @@index([userId])
  @@index([documentId])
  @@index([questionPaperId])
  @@index([threadId])
  @@index([status])
}

// ========== CORRECTION REPORTS ==========

model CorrectionReport {
  id        String   @id @default(uuid())
  
  // Scoring
  score     Int      // 0-100
  grade     String   // A+, A, B+, B, C, D, F
  
  // Feedback arrays (stored as JSON)
  strengths      String[]
  weaknesses     String[]
  recommendations String[]
  
  // Summary
  summary   String   @db.Text
  
  // Full report data
  reportJson Json?
  
  // Processing
  taskId    String?  // Celery task ID
  
  createdAt DateTime @default(now())

  // Relations
  examSessionId String      @unique
  examSession   ExamSession @relation(fields: [examSessionId], references: [id], onDelete: Cascade)
}

// ========== LEARN SESSIONS ==========

model LearnSession {
  id        String   @id @default(uuid())
  threadId  String   @unique  // LangGraph thread ID
  lpId      String   // Learn Pack ID (Redis key)

  // Summary (LLM-generated on cleanup)
  title     String            // "Introduction to Photosynthesis"
  summary   String   @db.Text // 2-3 sentence summary

  // Topic Coverage
  topicsCovered      String[]
  topicsPlanned      Int       @default(0)
  topicsCompleted    Int       @default(0)

  // Performance
  overallUnderstanding Int     @default(0) // 0-100
  strengths           String[]
  areasToReview       String[]

  // Full report data
  summaryJson Json?

  // Meta
  messageCount Int      @default(0)
  status       LearnSessionStatus @default(ACTIVE)
  createdAt    DateTime @default(now())
  completedAt  DateTime?

  // Relations
  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  documentId String?
  document   Document? @relation(fields: [documentId], references: [id])

  @@index([userId])
  @@index([lpId])
  @@index([status])
}

enum LearnSessionStatus {
  ACTIVE     // Session in progress
  COMPLETED  // Session finished normally
  ABANDONED  // User left without finishing
}

// ========== TRANSACTIONS ==========

model Transaction {
  id                String            @id @default(uuid())
  
  // Razorpay IDs
  razorpayPaymentId String?           @unique
  razorpayOrderId   String?
  
  // Amount
  amount   Int    // Amount in paise (39900 = â‚¹399)
  currency String @default("INR")
  
  // Status
  status TransactionStatus
  type   TransactionType
  
  // Metadata
  metadata Json?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([razorpayPaymentId])
  @@index([status])
}

// ========== ENUMS ==========

enum DocumentStatus {
  PENDING    // Uploaded, not processed
  PROCESSING // Currently being processed
  READY      // Ready for use
  FAILED     // Processing failed
}

enum ExamMode {
  EXAM  // Strict exam mode
  LEARN // Interactive learning mode
}

enum ExamStatus {
  SCHEDULED   // QP created, waiting to start
  IN_PROGRESS // Exam ongoing
  COMPLETED   // Exam finished
  ABANDONED   // User left without finishing
}

enum TransactionStatus {
  PENDING  // Awaiting payment
  SUCCESS  // Payment successful
  FAILED   // Payment failed
  REFUNDED // Refunded
}

enum TransactionType {
  PACK_PURCHASE  // One-time pack purchase
  TOP_UP         // Extra credits purchase
  REFUND         // Refund issued
}

enum QPStatus {
  PENDING
  PROCESSING
  READY
  FAILED
}

model QuestionPaper {
  id        String   @id @default(uuid())
  status    QPStatus @default(PENDING)
  
  // Params from qp_agent.py
  duration     Int
  numQuestions Int      @default(10)
  typeOfQp     String   @default("regular")
  
  // Configuration (Arrays stored as JSON/String[] since Postgres supports it)
  difficulty    String[] 
  bloomLevel    String[]
  questionTypes String[]
  
  // Output Content
  questions    Json?    // Full QP stored permanently here
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  documentId String
  document   Document @relation(fields: [documentId], references: [id])
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  examSessions ExamSession[]

  @@index([userId])
  @@index([documentId])
  @@index([status])
}
